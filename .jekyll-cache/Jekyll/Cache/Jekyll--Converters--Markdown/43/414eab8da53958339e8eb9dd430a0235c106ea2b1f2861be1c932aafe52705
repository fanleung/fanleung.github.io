I"¦ï<h3 id="ç¬¬2ç« -å¤„ç†æ–‡ä»¶æ‘„åƒå¤´å’Œå›¾å½¢ç”¨æˆ·ç•Œé¢">ç¬¬2ç«  å¤„ç†æ–‡ä»¶ã€æ‘„åƒå¤´å’Œå›¾å½¢ç”¨æˆ·ç•Œé¢</h3>

<h4 id="211-è¯»å†™å›¾åƒæ–‡ä»¶">2.1.1 è¯»/å†™å›¾åƒæ–‡ä»¶</h4>
<p>OpenCV çš„<code class="highlighter-rouge">imread()</code>å‡½æ•° å’Œ <code class="highlighter-rouge">imwrite()</code>å‡½æ•°èƒ½å¤Ÿæ”¯æŒå„ç§é™æ€å›¾åƒæ–‡ä»¶æ ¼å¼ï¼Œéƒ½æ”¯æŒBMP,é€šå¸¸è¿˜æ”¯æŒPNGã€JPEG å’Œ TIFF æ ¼å¼</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æ¯ä¸ªåƒç´ éƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œä½†ä¸åŒæ ¼å¼è¡¨ç¤ºåƒç´ çš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚é€šè¿‡äºŒç»´ numpy æ•°ç»„ç®€å•åˆ›å»ºä¸€ä¸ªé»‘è‰²çš„æ­£æ–¹å½¢
# æ¯ä¸ªåƒç´ å€¼çš„èŒƒå›´æ˜¯ 0-255
</span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">img</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[0, 0, 0],
       [0, 0, 0],
       [0, 0, 0]], dtype=uint8)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä½¿ç”¨ cv2.cvtColor å‡½æ•°å°†å›¾åƒè½¬æ¢æˆ RGB æ ¼å¼
# ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªåƒç´ ä»ä¹‹å‰ä¸€ä¸ªå€¼è¡¨ç¤ºï¼Œå˜æˆç”±ä¸‰å…ƒæ•°ç»„è¡¨ç¤ºäº†ï¼Œæ¯ä¸ªæ•´å‹è¡¨ç¤ºä¸€ä¸ªB, G, Ré€šé“
# å…¶ä»–è‰²å½©ç©ºé—´ï¼ˆå¦‚HSVï¼‰ä¹Ÿä»¥åŒæ ·çš„æ–¹å¼æ¥è¡¨ç¤ºåƒç´ ï¼Œ åªæ˜¯å–å€¼èŒƒå›´å’Œé€šé“æ•°ç›®ä¸åŒï¼ŒHSVæ˜¯ 0-180
</span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
<span class="n">img</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[[0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]],

       [[0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]],

       [[0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]]], dtype=uint8)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æ‰§è¡Œç¬¬ä¸€æ­¥å¾—åˆ°çš„ç»“æœæ˜¯ï¼ˆ3ï¼Œ3ï¼‰
# å¦‚æœå°†å›¾åƒè½¬åŒ–ä¸º BGR æ ¼å¼ï¼Œshape ä¼šè¿”å› ï¼ˆ3,3,3ï¼‰ï¼Œè¿™è¡¨æ˜æ¯ä¸ªåƒç´ å­˜åœ¨ä¸‰ä¸ªé€šé“
</span><span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">shape</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(3, 3, 3)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## è¯»å–ä¸€ç§æ ¼å¼çš„å›¾åƒæ–‡ä»¶ ï¼Œç„¶åä¿å­˜ä¸ºå¦ä¸€ç§æ ¼å¼
</span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/test.png'</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">'../fanleungTest/test.jpg'</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<blockquote>
  <p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå³æ—¶å›¾åƒæ–‡ä»¶ä¸ºç°åº¦æ ¼å¼ï¼Œ<code class="highlighter-rouge">imread()</code> å‡½æ•°ä¹Ÿä¼šè¿”å› BGR æ ¼å¼çš„å›¾åƒï¼ŒBGR ä¸ RGB æ‰€è¡¨ç¤ºçš„è€Œæ˜¯æ‰ç©ºé—´ç›¸åŒï¼Œä½†å­—èŠ‚é¡ºåºç›¸å</p>
</blockquote>

<p>ä»¥ä¸‹ä¸º imread() å‡½æ•°çš„å¯é€‰å‚æ•°</p>
<ul>
  <li>IMREAD_ANYCOLOR = 4</li>
  <li>IMREAD_ANYDEPTH = 2</li>
  <li>IMREAD_COLOR = 1</li>
  <li>IMREAD_GRAYSCALE = 0</li>
  <li>IMREAD_LOAD_GDAL = 8</li>
  <li>IMREAD_UNCHANGED = -1</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grayImage</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/test.png'</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">'../fanleungTest/testGray.png'</span><span class="p">,</span> <span class="n">grayImage</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>æ— è®ºé‡‡ç”¨ä½•ç§æ¨¡å¼ï¼Œimread()å‡½æ•°ä¼šåˆ é™¤æ‰€æœ‰alpha é€šé“çš„ä¿¡æ¯ï¼ˆé€æ˜åº¦ï¼‰, imwrite()å‡½æ•°è¦æ±‚å‡½æ•°ä¸ºBGR æ ¼å¼æˆ–ç°åº¦æ ¼å¼ï¼Œå¹¶ä¸”æ¯ä¸ªé€šé“è¦æœ‰ä¸€å®šçš„ä½ï¼ˆbitï¼‰ï¼Œè¾“å‡ºæ ¼å¼è¦æ”¯æŒè¿™äº›é€šé“ï¼Œå¦‚ bmp æ ¼å¼è¦æ±‚æ¯ä¸ªé€šé“æœ‰ 8 ä½ï¼Œ è€Œ PNG å…è®¸æ¯ä¸ªé€šé“æœ‰ 8 ä½æˆ– 16 ä½</p>

<h4 id="212-å›¾åƒå’ŒåŸå§‹å­—èŠ‚ä¹‹é—´çš„è½¬æ¢">2.1.2 å›¾åƒå’ŒåŸå§‹å­—èŠ‚ä¹‹é—´çš„è½¬æ¢</h4>
<ul>
  <li>ä¸€ä¸ª OpenCV å›¾åƒæ˜¯ array ç±»å‹çš„äºŒç»´æˆ–ä¸‰ç»´æ•°ç»„ï¼Œ8ä½ç°åº¦å›¾åƒæ˜¯ä¸€ä¸ªå«æœ‰å­—èŠ‚å€¼çš„äºŒç»´æ•°ç»„ï¼Œ24 ä½çš„ BGR å›¾åƒæ˜¯ä¸€ä¸ªä¸‰ç»´æ•°ç»„ï¼Œå¯ä½¿ç”¨è¡¨è¾¾å¼è®¿é—®è¿™äº›å€¼ã€‚</li>
  <li>ä¾‹å¦‚image[0,0] å’Œ image[0, 0, 0],ç¬¬ä¸€ä¸ªå€¼ä»£è¡¨åƒç´ çš„ y åæ ‡æˆ–è¡Œï¼Œ0 è¡¨ç¤ºé¡¶éƒ¨ï¼Œ ç¬¬äºŒä¸ªå€¼æ˜¯åƒç´ çš„ x åæ ‡æˆ–è€…åˆ—ï¼Œ0 è¡¨ç¤ºæœ€å·¦è¾¹ï¼Œ ç¬¬ä¸‰ä¸ªå€¼è¡¨ç¤ºé¢œè‰²é€šé“</li>
  <li>å¯¹äºä¸€ä¸ªå·¦ä¸Šè§’æœ‰ç™½è‰²åƒç´ çš„ 8 ä½ç°åº¦å›¾åƒè€Œè¨€ï¼Œimage[0, 0] = 255, å¯¹äºä¸€ä¸ªå·¦ä¸Šè§’æœ‰è“è‰²åƒç´ çš„ 24 ä½ BGR å›¾åƒè€Œè¨€ï¼Œ image[0, 0] = [255, 0, 0]</li>
</ul>

<h5 id="å°†éšæœºå­—èŠ‚-bytearray-è½¬åŒ–ä¸º-ç°åº¦å›¾åƒ-å’Œ-bgr-å›¾åƒ">å°†éšæœºå­—èŠ‚ bytearray è½¬åŒ–ä¸º ç°åº¦å›¾åƒ å’Œ BGR å›¾åƒ</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># make an array of 120,000 random bytes
#randomByteArray = bytearray(os.urandom(120000))
</span><span class="n">randomByteArray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">120000</span><span class="p">)</span>
<span class="c1">#randomByteArray
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flatNumpyArray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">randomByteArray</span><span class="p">)</span>
<span class="c1">#flatNumpyArray
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert the array to make a 400x300 grayscale image
</span><span class="n">grayImage</span> <span class="o">=</span> <span class="n">flatNumpyArray</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">'../fanleungTest/RandomGray.png'</span><span class="p">,</span> <span class="n">grayImage</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert the array to make a 400x300 color image
</span><span class="n">bgrImage</span> <span class="o">=</span> <span class="n">flatNumpyArray</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">'../fanleungTest/RandomColor.png'</span><span class="p">,</span> <span class="n">bgrImage</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># åˆ¶ä½œæ•°æ®ä¹Ÿå¯ä»¥ä¸€å¥ä»£ç å®ç°
</span><span class="n">grayImage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">120000</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="213-ä½¿ç”¨-numpyarray-è®¿é—®å›¾åƒæ•°æ®">2.1.3 ä½¿ç”¨ numpy.array è®¿é—®å›¾åƒæ•°æ®</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ç”±äºåœ¨jupyter notebook ä¸­è°ƒç”¨ cv2.imshow() ä¼šå¥”æºƒï¼Œè¿™é‡Œé‡æ„ä¸€ä¸‹å‡½æ•°
# ä¹Ÿå¯ä»¥ä½¿ç”¨ from matplotlib import pyplot as plt æ¥æ˜¾ç¤ºå›¾ç‰‡
# plt.imshow(img)
# plt.show()
</span><span class="k">def</span> <span class="nf">cv2_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'temp'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

</code></pre></div></div>

<h5 id="å°†-bgr-å›¾åƒåœ¨-0-0å¤„çš„åƒç´ è½¬åŒ–ä¸ºç™½è‰²">å°† BGR å›¾åƒåœ¨ (0, 0)å¤„çš„åƒç´ è½¬åŒ–ä¸ºç™½è‰²</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/MyPic.png'</span><span class="p">)</span>
<span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
<span class="n">cv2_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="å°†åæ ‡-150-120-çš„å½“å‰è“è‰²å€¼127æ”¹æˆ-255">å°†åæ ‡ (150, 120) çš„å½“å‰è“è‰²å€¼ï¼ˆ127ï¼‰æ”¹æˆ 255</h5>
<ul>
  <li>numpy.array æä¾›çš„ item() æ–¹æ³•éå¸¸æ–¹ä¾¿ï¼Œè¯¥å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼šx,y,BGRçš„é€šé“å€¼ï¼š0æ˜¯Bï¼Œ1æ˜¯G, 2æ˜¯R, è¿”å›ç´¢å¼•çš„å€¼</li>
  <li>itemset()å‡½æ•°å¯è®¾ç½®æŒ‡å®šåƒç´ åœ¨æŒ‡å®šé€šé“çš„å€¼ï¼Œitemset()å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼šä¸‰å…ƒç»„ï¼ˆx,y,é€šé“å€¼ï¼‰å’Œè¦è®¾ç½®çš„å€¼</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/MyPic.png'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>168
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span><span class="o">.</span><span class="n">itemset</span><span class="p">((</span><span class="mi">150</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">255</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">cv2_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>255
</code></pre></div></div>

<blockquote>
  <p>ä½¿ç”¨ numpy.array çš„åŸå› æœ‰ä¸¤ä¸ªnumpy.array ç»è¿‡ä¼˜åŒ–ï¼Œå¯è¯»æ€§å¼ºï¼Œè¿™é‡Œä¸ä½¿ç”¨ç¬¬ä¸€ä¸ªç¤ºä¾‹çš„æ–¹å¼è®¿é—®åŸå§‹ç´¢å¼•</p>
</blockquote>

<p>è¿™ç§ç‰¹æ®Šçš„ä»£ç æœ¬èº«å¹¶ä¸èƒ½å®Œæˆå¤šå°‘åŠŸèƒ½ï¼Œä½†å®ƒæä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œå»ºè®®ä½¿ç”¨å†…ç½®çš„æ»¤æ³¢å™¨å’Œæ–¹æ³•æ¥å¤„ç†æ•´ä¸ªå›¾åƒï¼Œä¸Šè¿°æ–¹æ³•åªé€‚åˆå¤„ç†ç‰¹å®šçš„å°åŒºåŸŸã€‚</p>

<blockquote>
  <p>æç¤ºï¼šé€šè¿‡å¾ªç¯æ¥å¤„ç† python çš„æ•°æ®æ•ˆç‡éå¸¸ä½ï¼Œåº”å°½é‡é¿å…è¿™ç§æ–¹å¼ã€‚ä½¿ç”¨æ•°ç»„ç´¢å¼•å¯ä»¥é«˜æ•ˆåœ°æ“ä½œåƒç´ ã€‚åƒç´ æ“ä½œæ˜¯ä¸€ä¸ªé«˜ä»£ä»·çš„ä½æ•ˆæ“ä½œï¼Œè§†é¢‘å¤„ç†è¦å¾ˆä¹…æ‰èƒ½å¾—åˆ°ç»“æœã€‚å¯ç”¨ç´¢å¼•ï¼ˆindexingï¼‰æ¥è§£å†³è¿™ä¸ªé¢å¤–éš¾é¢˜ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç å¯å°†å›¾åƒæ‰€æœ‰çš„G(ç»¿è‰²)å€¼è®¾ç½®ä¸º0</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cv2
import numpy as np
img = cv2.imread('MyPic.png')
img[:, :, 1] = 0
</code></pre></div>  </div>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="c1"># from matplotlib import pyplot as plt
</span><span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/MyPic.png'</span><span class="p">)</span>
<span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cv2_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

</code></pre></div></div>

<h5 id="æ„Ÿå…´è¶£åŒºåŸŸ-region-of-interest-roi">æ„Ÿå…´è¶£åŒºåŸŸ ï¼ˆRegion Of Interest, ROIï¼‰</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/MyPic.png'</span><span class="p">)</span>
<span class="n">my_roi</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span>
<span class="n">img</span><span class="p">[</span><span class="mi">190</span><span class="p">:</span><span class="mi">290</span><span class="p">,</span> <span class="mi">190</span><span class="p">:</span><span class="mi">290</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_roi</span>
<span class="n">cv2_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span> 
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/MyPic.png'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(290, 290, 3)
252300
uint8
</code></pre></div></div>

<h5 id="è¿™ä¸‰ä¸ªå±æ€§åˆ†åˆ«ä¸º">è¿™ä¸‰ä¸ªå±æ€§åˆ†åˆ«ä¸º</h5>
<ul>
  <li>shape: åŒ…æ‹¬å®½åº¦ã€é«˜åº¦å’Œé€šé“æ•°ï¼Œ å¦‚æœå›¾åƒæ˜¯å•è‰²æˆ–è€…ç°åº¦çš„ï¼Œåˆ™ä¸åŒ…å«é€šé“å€¼</li>
  <li>size: å›¾åƒåƒç´ å¤§å°</li>
  <li>dtype: å›¾åƒçš„æ•°æ®ç±»å‹ï¼Œä¸€èˆ¬ä¸ºæ— ç¬¦å·æ•´å‹ï¼Œæ¯”å¦‚uint8</li>
</ul>

<h4 id="214-è§†é¢‘æ–‡ä»¶çš„è¯»å†™">2.1.4 è§†é¢‘æ–‡ä»¶çš„è¯»/å†™</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å°†ä¸€å¹…å›¾åƒä¼ é€’ç»™ videoWriter çš„ write() å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†è¿™ä¸ªå›¾åƒåŠ è½½åˆ°VideoWrite()æ‰€æŒ‡å‘çš„æ–‡ä»¶ä¸­
# è¯»å– avi æ–‡ä»¶çš„å¸§ï¼Œå¹¶é‡‡ç”¨ YUV é¢œè‰²ç¼–ç å°†å…¶å†™å…¥å¦ä¸€ä¸ªå¸§ä¸­:
# æŠŠä¸€ä¸ªè§†é¢‘è½¬åŒ–ä¸ºå¦ä¸€ä¸ªè§†é¢‘ï¼Œå³ MyInputVid è½¬åŒ–ä¸º MyInputVid1,ä½†æ˜¯ç”¨ä¸åŒçš„ç¼–ç æ ¼å¼YUV
</span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">videoCapture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s">'../fanleungTest/MyInputVid.avi'</span><span class="p">)</span>
<span class="c1"># è¯»å–è¿™ä¸ªè§†é¢‘çš„å¸§é€Ÿ
</span><span class="n">fps</span> <span class="o">=</span> <span class="n">videoCapture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">videoCapture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">videoCapture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span>
<span class="n">videoWriter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s">'../fanleungTest/MyInputVid_converse.avi'</span><span class="p">,</span>
                             <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s">'I'</span><span class="p">,</span> <span class="s">'4'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">,</span> <span class="s">'0'</span><span class="p">),</span>
                             <span class="n">fps</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">videoCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">while</span> <span class="n">success</span><span class="p">:</span>
    <span class="n">videoWriter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">videoCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    
</code></pre></div></div>

<p>æ³¨æ„ï¼š å¿…é¡»è¦ä¸ºVideoWriterç±»æ„å»ºå‡½æ•°æŒ‡å®šè§†é¢‘æ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶åå¯¹åº”çš„æ–‡ä»¶è‹¥å­˜åœ¨ï¼Œå°±ä¼šè¢«è¦†ç›–ã€‚ä¹Ÿå¿…é¡»æŒ‡å®šè§†é¢‘ç¼–ç è§£ç å™¨ã€‚ç¼–ç è§£ç å™¨çš„å¯ç”¨æ€§æ ¹æ®ç³»ç»Ÿä¸åŒè€Œä¸åŒï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨é€‰é¡¹ï¼š</p>

<ul>
  <li>cv2.VideoWriter_fourccï¼ˆâ€™Iâ€™ï¼Œâ€™4â€™ï¼Œâ€™2â€™ï¼Œâ€™0â€™ï¼‰ï¼šè¯¥é€‰é¡¹æ˜¯ä¸€ä¸ªæœªå‹ç¼©çš„YUVé¢œè‰²ç¼–ç ï¼Œæ˜¯4:2:0è‰²åº¦å­é‡‡æ ·ã€‚è¿™ç§ç¼–ç æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ï¼Œä½†ä¼šäº§ç”Ÿè¾ƒå¤§æ–‡ä»¶ï¼Œæ–‡ä»¶æ‰©å±•åä¸º.avi</li>
  <li>cv2.VideoWriter_fourccï¼ˆâ€™Pâ€™ï¼Œâ€™Iâ€™ï¼Œâ€™Mâ€™ï¼Œâ€™1â€™ï¼‰ï¼šè¯¥é€‰é¡¹æ˜¯MPEG-1ç¼–ç ç±»å‹ï¼Œæ–‡ä»¶æ‰©å±•åä¸º.avi</li>
  <li>cv2.VideoWriter_fourccï¼ˆâ€™Xâ€™ï¼Œâ€™Vâ€™ï¼Œâ€™Iâ€™ï¼Œâ€™Dâ€™ï¼‰ï¼šè¯¥é€‰é¡¹æ˜¯MPEG-4ç¼–ç ç±»å‹ï¼Œå¦‚æœå¸Œæœ›å¾—åˆ°çš„è§†é¢‘å¤§å°ä¸ºå¹³å‡å€¼ï¼Œæ¨èä½¿ç”¨æ­¤é€‰é¡¹ï¼Œæ–‡ä»¶æ‰©å±•åä¸º.avi</li>
  <li>cv2.VideoWriter_fourccï¼ˆâ€™Tâ€™ï¼Œâ€™Hâ€™ï¼Œâ€™Eâ€™ï¼Œâ€™Oâ€™ï¼‰ï¼šè¯¥é€‰é¡¹æ˜¯Ogg Vorbisï¼Œæ–‡ä»¶æ‰©å±•ååº”ä¸º.ogv</li>
  <li>cv2.VideoWriter_fourccï¼ˆâ€™Fâ€™ï¼Œâ€™Lâ€™ï¼Œâ€™Vâ€™ï¼Œâ€™1â€™ï¼‰ï¼šè¯¥é€‰é¡¹æ˜¯ä¸€ä¸ªFlashè§†é¢‘ï¼Œæ–‡ä»¶æ‰©å±•ååº”ä¸º.flv</li>
</ul>

<p>å¸§é€Ÿç‡å’Œå¸§å¤§å°ä¹Ÿå¿…é¡»è¦æŒ‡å®šï¼Œå› ä¸ºéœ€è¦ä»å¦ä¸€ä¸ªè§†é¢‘æ–‡ä»¶å¤åˆ¶è§†é¢‘å¸§ï¼Œè¿™äº›å±æ€§å¯ä»¥é€šè¿‡VideoCaptureç±»çš„get()å‡½æ•°å¾—åˆ°ã€‚</p>

<h4 id="215-æ•è·æ‘„åƒå¤´çš„å¸§">2.1.5 æ•è·æ‘„åƒå¤´çš„å¸§</h4>
<p>VideoCapture ç±»å¯ä»¥è·å–æ‘„åƒå¤´çš„å¸§æµï¼Œä½†å¯¹æ‘„åƒå¤´è€Œè¨€ï¼Œé€šå¸¸ä¸æ˜¯ç”¨è§†é¢‘çš„æ–‡ä»¶åæ¥æ„å»º VideoCapture ç±»ï¼Œè€Œæ˜¯éœ€è¦ä¼ é€’æ‘„åƒå¤´çš„è®¾å¤‡ç´¢å¼•ï¼ˆdevice indexï¼‰<strong>(ä¸€ä¸ªæ˜¯è§†é¢‘æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ‘„åƒå¤´)</strong></p>

<h4 id="æ•è·æ‘„åƒå¤´-10-ç§’çš„è§†é¢‘ä¿¡æ¯å¹¶å†™å…¥-myoutputvidavi">æ•è·æ‘„åƒå¤´ 10 ç§’çš„è§†é¢‘ä¿¡æ¯ï¼Œå¹¶å†™å…¥ MyOutputVid.avi</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">cameraCapture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fps</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># an assumption
</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cameraCapture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">)),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">cameraCapture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span>
<span class="n">videoWriter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s">'../fanleungTest/MyOutputVid.avi'</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s">'I'</span><span class="p">,</span> <span class="s">'4'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">,</span> <span class="s">'0'</span><span class="p">),</span>
                             <span class="n">fps</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cameraCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">numFrameRemaining</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">fps</span> <span class="o">-</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">numFrameRemaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">videoWriter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cameraCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">numFrameRemaining</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="n">cameraCapture</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

</code></pre></div></div>

<p>ç„¶è€Œï¼Œ VideoCapture.get() æ–¹æ³•ä¸èƒ½è¿”å›æ‘„åƒå¤´å¸§é€Ÿç‡çš„å‡†ç¡®å€¼ï¼Œå®ƒæ€»æ˜¯è¿”å› 0, äºæ˜¯åªèƒ½å‡è®¾ä¸€ä¸ªå¸§é€Ÿï¼Œæˆ–è€…ç”¨ä¸€ä¸ªå®šæ—¶å™¨æ¥æµ‹é‡ï¼Œè¿™ç§åŠæ³•ä¼šæ›´å¥½ä¸€äº›</p>

<h4 id="ä¸€ç»„æ‘„åƒå¤´æˆ–ä¸€ä¸ªå¤šå¤´æ‘„åƒå¤´">ä¸€ç»„æ‘„åƒå¤´æˆ–ä¸€ä¸ªå¤šå¤´æ‘„åƒå¤´</h4>
<p>read() æ–¹æ³•ä¸å†é€‚åˆäº†ï¼Œå¯ç”¨grab()å’Œretrive()æ–¹æ³•æ›¿ä»£å®ƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>success0 = cameraCapture0.grab()
success1 = cameraCapture1.grab()
if success0 and success1:
    frame0 = cameraCapture0.retrive()
    frame1 = cameraCapture1.retrive()
</code></pre></div></div>

<h4 id="216-åœ¨çª—å£æ˜¾ç¤ºå›¾åƒ">2.1.6 åœ¨çª—å£æ˜¾ç¤ºå›¾åƒ</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'../fanleungTest/test.jpg'</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'my image'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div></div>

<p>è°ƒç”¨destroyAllWindows()å‡½æ•°å¯ä»¥é‡Šæ”¾ç”±OpenCVåˆ›å»ºçš„æ‰€æœ‰çª—å£</p>

<h4 id="217-åœ¨çª—å£æ˜¾ç¤ºæ‘„åƒå¤´å¸§">2.1.7 åœ¨çª—å£æ˜¾ç¤ºæ‘„åƒå¤´å¸§</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># é€šè¿‡ setMouseCallback() å‡½æ•°æ¥è·å–é¼ æ ‡è¾“å…¥ï¼Œå®æ—¶æ˜¾ç¤ºæ‘„åƒå¤´å¸§
</span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">clicked</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">def</span> <span class="nf">onMouse</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">clicked</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_LBUTTONUP</span><span class="p">:</span>
        <span class="n">clicked</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">cameraCapture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s">'MyWindow'</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="s">'MyWindow'</span><span class="p">,</span> <span class="n">onMouse</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'showing camera feed. click window or press any key to stop'</span><span class="p">)</span>

<span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cameraCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">while</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clicked</span><span class="p">:</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'Mywindow'</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cameraCapture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="s">'MyWindow'</span><span class="p">)</span>
<span class="n">cameraCapture</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>showing camera feed. click window or press any key to stop
</code></pre></div></div>

<h3 id="22-cameo-é¡¹ç›®äººè„¸è·Ÿè¸ªå’Œå›¾åƒå¤„ç†">2.2 Cameo é¡¹ç›®ï¼ˆäººè„¸è·Ÿè¸ªå’Œå›¾åƒå¤„ç†ï¼‰</h3>

<h3 id="23-cameo--é¢å‘å¯¹è±¡çš„è®¾è®¡">2.3 Cameo â€“ é¢å‘å¯¹è±¡çš„è®¾è®¡</h3>
<p>2.3.1 ä½¿ç”¨ managers.CaptureManager æå–è§†é¢‘æµ</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># managers.py
</span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">CaptureManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capture</span><span class="p">,</span> <span class="n">previewWindowManager</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">shouldMirrorPreview</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">previewWindowManager</span> <span class="o">=</span> <span class="n">previewWindowManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shouldMirrorPreview</span> <span class="o">=</span> <span class="n">shouldMirrorPreview</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="o">=</span> <span class="n">capture</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imageFilename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoFilename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoEncoding</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoWriter</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_startTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_framesElapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fpsEstimate</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span>
    
    <span class="o">@</span><span class="n">channel</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># As of OpenCV 3.0, VideoCapture.retrieve() no longer supports
</span>            <span class="c1"># the channel argument.
</span>            <span class="c1"># _, self._frame = self._capture.retrieve(channel = self.channel)
</span>            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span>
    
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">isWritingImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageFilename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">isWritingVideo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_videoFilename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">enterFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Capture the next frame, if any."""</span>
        
        <span class="c1"># But first, check that any previous frame was exited.
</span>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span><span class="p">,</span> \
            <span class="s">'previous enterFrame() had no matching exitFrame()'</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">exitFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Draw to the window. Write to files. Release the frame."""</span>
        
        <span class="c1"># Check whether any grabbed frame is retrievable.
</span>        <span class="c1"># The getter may retrieve and cache the frame.
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>
        
        <span class="c1"># Update the FPS estimate and related variables.
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_framesElapsed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeElapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fpsEstimate</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_framesElapsed</span> <span class="o">/</span> <span class="n">timeElapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_framesElapsed</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Draw to the window, if any.
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previewWindowManager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shouldMirrorPreview</span><span class="p">:</span>
                <span class="n">mirroredFrame</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previewWindowManager</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">mirroredFrame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previewWindowManager</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">)</span>
        
        <span class="c1"># Write to the image file, if any.
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isWritingImage</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageFilename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageFilename</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Write to the video file, if any.
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_writeVideoFrame</span><span class="p">()</span>
        
        <span class="c1"># Release the frame.
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enteredFrame</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">writeImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s">"""Write the next exited frame to an image file."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imageFilename</span> <span class="o">=</span> <span class="n">filename</span>
    
    <span class="k">def</span> <span class="nf">startWritingVideo</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s">'M'</span><span class="p">,</span><span class="s">'J'</span><span class="p">,</span><span class="s">'P'</span><span class="p">,</span><span class="s">'G'</span><span class="p">)):</span>
        <span class="s">"""Start writing exited frames to a video file."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoFilename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoEncoding</span> <span class="o">=</span> <span class="n">encoding</span>
    
    <span class="k">def</span> <span class="nf">stopWritingVideo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop writing exited frames to a video file."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoFilename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoEncoding</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoWriter</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">_writeVideoFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isWritingVideo</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_videoWriter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fps</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># The capture's FPS is unknown so use an estimate.
</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_framesElapsed</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="c1"># Wait until more frames elapse so that the
</span>                    <span class="c1"># estimate is more stable.
</span>                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fpsEstimate</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">)),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_videoWriter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_videoFilename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_videoEncoding</span><span class="p">,</span>
                <span class="n">fps</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_videoWriter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WindowManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windowName</span><span class="p">,</span> <span class="n">keypressCallback</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keypressCallback</span> <span class="o">=</span> <span class="n">keypressCallback</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_windowName</span> <span class="o">=</span> <span class="n">windowName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isWindowCreated</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">isWindowCreated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isWindowCreated</span>
    
    <span class="k">def</span> <span class="nf">createWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windowName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isWindowCreated</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windowName</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">destroyWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windowName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isWindowCreated</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">processEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keycode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypressCallback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">keycode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Discard any non-ASCII info encoded by GTK.
</span>            <span class="n">keycode</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keypressCallback</span><span class="p">(</span><span class="n">keycode</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cameo.py
</span>
<span class="c1"># å…ˆè¿è¡Œä¸Šé¢çš„ managers.py
# ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªèƒ½æ˜¾ç¤ºæ‘„åƒå¤´å¸§ï¼Œç›‘å¬é”®ç›˜è¾“å…¥ä»¥åŠæˆªå›¾æˆ–å½•å±çš„åº”ç”¨äº†
</span><span class="kn">import</span> <span class="nn">cv2</span>

<span class="k">class</span> <span class="nc">Cameo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># åˆå§‹åŒ– CaptureManager ç±»æ—¶ï¼Œ shouldMirrorPreview ä¸ºTrue, å¯¼è‡´æ‘„åƒå¤´è¢«é•œåƒï¼Œä½†æ˜¯æˆªå›¾å’Œå½•å±ä¸ä¼šé•œåƒ
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="p">(</span><span class="s">'Cameo'</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">onKeypress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span> <span class="o">=</span> <span class="n">CaptureManager</span><span class="p">(</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Run the main loop."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span><span class="o">.</span><span class="n">createWindow</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span><span class="o">.</span><span class="n">isWindowCreated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">enterFrame</span><span class="p">()</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">frame</span>
            
            <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># TODO: Filter the frame (Chapter 3).
</span>                <span class="k">pass</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">exitFrame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">onKeypress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keycode</span><span class="p">):</span>
        <span class="s">"""Handle a keypress.
        
        space  -&gt; Take a screenshot.
        tab    -&gt; Start/stop recording a screencast.
        escape -&gt; Quit.
        
        """</span>
        <span class="k">if</span> <span class="n">keycode</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span> <span class="c1"># space
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">writeImage</span><span class="p">(</span><span class="s">'../fanleungTest/screenshot.png'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">keycode</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span> <span class="c1"># tab
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">isWritingVideo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">startWritingVideo</span><span class="p">(</span>
                    <span class="s">'../fanleungTest/screencast.avi'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_captureManager</span><span class="o">.</span><span class="n">stopWritingVideo</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">keycode</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span> <span class="c1"># escape
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_windowManager</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">Cameo</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

:ET